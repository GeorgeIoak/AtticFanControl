<!DOCTYPE html>
<html>
<head>
  <title>Attic Fan Web Server</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
  body { font-family: Arial, sans-serif; text-align: center; margin-top: 10px; }
  h1, h2 { margin-top: 15px; margin-bottom: 10px; }
  .control-group { margin-bottom: 20px; padding: 10px; }
  .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
  .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: #2196F3; }
  input:checked + .slider:before { transform: translateX(26px); }
  .content-section { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
  #configForm input {
    width: 100px;
    min-width: 70px;
    max-width: 100%;
    margin: 0 auto;
    padding-left: 10px;
    padding-right: 10px;
    box-sizing: border-box;
  }
  #configForm button { margin: 5px; padding: 8px 12px; }
  .btn { padding: 8px 16px; border: 1px solid transparent; border-radius: 4px; cursor: pointer; font-size: 1em; }
  .btn-danger { color: #fff; background-color: #dc3545; border-color: #dc3545; }
  .btn-primary { color: #fff; background-color: #007bff; border-color: #007bff; text-decoration: none; display: inline-block; }
  #fan-icon-container { width: 60px; height: 60px; }
  .section-save-btn {
    padding: 8px 24px;
    background: linear-gradient(90deg, #2196F3 0%, #21CBF3 100%);
    color: #fff;
    border: none;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(33,150,243,0.08);
    font-size: 1em;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s;
    text-decoration: none;
    display: inline-block;
  }
  .section-save-btn:hover {
    background: linear-gradient(90deg, #1976D2 0%, #00BCD4 100%);
    box-shadow: 0 4px 16px rgba(33,150,243,0.16);
  }
  .section-save-btn.btn-danger {
    background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
  }
  .section-save-btn.btn-danger:hover {
    background: linear-gradient(90deg, #c82333 0%, #bd2130 100%);
  }
  .section-save-btn:disabled {
    background: #ccc;
    box-shadow: none;
    cursor: not-allowed;
    opacity: 0.6;
  }
  .system-controls { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px 15px; }
  .toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 1; left: 50%; transform: translateX(-50%); bottom: 30px; }
  .fan-icon { width: 100%; height: 100%; fill: #888; }
  .sensor-item { padding: 10px; border: 1px solid #ddd; border-radius: 8px; min-width: 120px; }
  .config-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 15px; align-items: stretch; } 
  .config-item { display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 80px; }
  .number-input-wrapper { display: flex; align-items: center; justify-content: center; }
  .sensor-grid { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; }
  .number-input-wrapper input { text-align: center; font-size: 1.2em; height: 44px; width: 100%; border: 1px solid #ccc; border-radius: 4px; -moz-appearance: textfield; }
  .page-container { max-width: 1000px; margin: 0 auto; padding: 0 10px; box-sizing: border-box; }
  #mode-control-box { border: 1px solid #ddd; border-radius: 8px; padding: 15px; max-width: 400px; margin: 0 auto; }
  .weather-forecast { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
  .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; }
  .modal-content .config-item { min-width: 150px; }
  .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
  #timerStatus { font-size: 0.9em; color: #007bff; font-weight: bold; margin-top: 5px; display: none; }
  .fan-status-container { display: flex; justify-content: center; align-items: center; gap: 15px; margin: 10px 0; }
  .fan-text-container { text-align: left; }
  .fan-text-container p {
    margin: 0;
    line-height: 1.4;
  }
  #manualOnBtn, #manualOffBtn, #setTimerBtn { margin: 2px; }
  .help-link { font-size: 0.8em; vertical-align: super; text-decoration: none; color: #007bff; }
  .mode-buttons-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
  .settings-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 15px; }  
  .settings-group { border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px 10px; flex: 1; min-width: 280px; display: flex; flex-direction: column; }
  .config-subheading { margin-top: 0; margin-bottom: 10px; text-align: left; color: #555; }
  .unit-note { font-size: 0.9em; color: #6c757d; margin-top: -5px; margin-bottom: 10px; }
  /* Responsive Chart Height */
  #historyChart {
    height: 200px !important; /* Default portrait height */
  }
  @media (orientation: landscape) {
    #historyChart {
      height: 250px !important; /* Taller for landscape mode */
    }
  }
  /* Container to center the history chart */
  .chart-container {
    display: block;
    max-width: 800px; /* Or another width that you prefer */
    margin: 0 auto;   /* This centers the container */
  }
  .smart-pre-cool-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  grid-template-rows: 44px auto 70px; /* Fixed height for label row, fixed height for button/help row */
  gap: 8px 12px;
  align-items: start;
  }
  /* Ensure all .spc-labels in both Core Automation and Pre-Cooling have same height/alignment */
  .smart-pre-cool-grid .spc-label {
  text-align: center;
  font-weight: 500;
  height: 40px; /* Reserve space for two lines, fixed height */
  display: flex;
  align-items: flex-start; /* Align text to the top */
  justify-content: center;
  padding-top: 0;
  }
          .smart-pre-cool-grid .number-input-wrapper {
            justify-self: center;
            width: 100%;
          }
          .smart-pre-cool-grid .number-input-wrapper input {
            width: 100px;
            min-width: 70px;
            max-width: 100%;
            padding-left: 10px;
            padding-right: 10px;
            box-sizing: border-box;
            margin: 0 auto;
          }
  .smart-pre-cool-grid .spc-save-cell {
    padding-top: 4px;
  }
  .smart-pre-cool-grid .spc-help-cell {
    padding-top: 4px;
    font-size: 0.95em;
    color: #6c757d;
  }
  #test-panel input[type=range] {
    width: 100%;
  }
  #test-panel .config-grid {
    gap: 32px;
  }
  @media (max-width: 480px) {
    .smart-pre-cool-grid .number-input-wrapper input,
    #configForm input {
      width: 80px;
      min-width: 60px;
      max-width: 95vw;
    }
    .smart-pre-cool-grid {
      grid-template-rows: 52px auto 90px; /* Slightly taller for mobile, fixed height for button/help row */
    }
  }
  </style>
</head>
<body>
<div class="page-container">
  <h1>Attic Fan Control</h1>
  <div class="top-info-flex">
    <div id="sensorData" class="sensor-grid">
      <div class="sensor-item">
        <strong>Attic</strong>
        <div><span id="atticTemp">--</span>Â°F / <span id="atticHumidity">--</span>%</div>
      </div>
      <div class="sensor-item">
        <strong>Outdoor</strong>
        <div><span id="outdoorTemp">--</span>Â°F</div>
      </div>
    </div>
    <div class="weather-forecast-block">
      <h2>Weather Forecast</h2>
      <p>Current: <span id="currentWeatherIcon"></span> <span id="currentWeatherTemp">--</span>Â°F / <span id="currentWeatherHumidity">--</span>%</p>
      <div class="weather-forecast" id="forecastContainer"></div>
    </div>
  </div>

  <div class="content-section">
    <h2>History</h2>
    <div class="chart-container">
      <canvas id="historyChart"></canvas>
      <div id="historyChartMsg" style="color: #888; font-size: 0.95em; margin-top: 8px;"></div>
    </div>
  </div>
    <div class="content-section">
      <div class="control-group" id="mode-control-box">
        <h3>Mode Control <a href="/help#mode-control" class="help-link" title="Click for detailed help on modes" aria-label="Help on mode control">(?)</a></h3>
        <div class="mode-buttons-container">
          <button id="autoModeBtn" class="section-save-btn" onclick="setMode('AUTO')">AUTO</button>
          <button id="manualModeBtn" class="section-save-btn" onclick="setMode('MANUAL')">MANUAL</button>
        </div>
        <div class="fan-status-container">
          <div id="fan-icon-container">
            <svg id="fan-icon" class="fan-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
              <path d="M50,15 A35,35 0 0,1 85,50 L50,50 Z" />
              <path d="M50,15 A35,35 0 0,0 15,50 L50,50 Z" transform="rotate(120 50 50)" />
              <path d="M50,15 A35,35 0 0,0 15,50 L50,50 Z" transform="rotate(240 50 50)" />
              <circle cx="50" cy="50" r="8" fill="#666"/>
            </svg>
          </div>
          <div class="fan-text-container">
            <p>Mode: <span id="currentMode">--</span></p>
            <p>Fan is <span id="fanState">OFF</span></p>
            <p id="timerStatus"></p>
          </div>
        </div>
        <div>
          <button id="manualOnBtn" class="section-save-btn" onclick="setFan('on')" disabled>Turn ON</button>
          <button id="manualOffBtn" class="section-save-btn" onclick="setFan('off')" disabled>Turn OFF</button>
          <button id="setTimerBtn" class="section-save-btn" onclick="openTimerModal()" disabled>Set Timer</button>
        </div>
      </div>
    </div>

    <div id="configForm" class="content-section">
      <h2>Fan Temp Control Settings <a href="/help#temp-settings" class="help-link" title="Click for detailed help on temperature settings" aria-label="Help on temperature settings">(?)</a></h2>
      <p class="unit-note">(All temperatures in Fahrenheit Â°F)</p>
      <div class="settings-container">
        <div class="settings-group">
          <h4 class="config-subheading">Core Automation</h4>
          <div class="config-grid smart-pre-cool-grid">
            <label for="fanOnTemp" title="The attic temperature at which the fan will consider turning on." class="spc-label">On Temp</label>
            <label for="fanDeltaTemp" title="Fan only runs if attic is this much hotter than outside. Prevents pulling in hot air." class="spc-label">Delta Temp</label>
            <label for="fanHysteresis" title="Prevents rapid on/off cycling. Fan turns off at (On Temp - Hysteresis)." class="spc-label">Hysteresis</label>

            <div class="number-input-wrapper"><input type="number" id="fanOnTemp" step="0.1" value="90.0"></div>
            <div class="number-input-wrapper"><input type="number" id="fanDeltaTemp" step="0.1" value="5.0"></div>
            <div class="number-input-wrapper"><input type="number" id="fanHysteresis" step="0.1" value="2.0"></div>

            <div class="spc-save-cell" style="grid-column: 1 / span 3; text-align: center; align-self: center; padding-top: 8px;">
              <button class="section-save-btn" onclick="saveCoreAutomation()">Save Core Automation</button>
            </div>
          </div>
        </div>
        <div class="settings-group">
          <h4 class="config-subheading">Smart Pre-Cooling</h4>
          <div class="config-grid smart-pre-cool-grid">
            <label for="preCoolTriggerTemp" title="If forecast high is at or above this, pre-cooling activates." class="spc-label">Pre-Cool Trigger</label>
            <label for="preCoolTempOffset" title="Lowers the 'On Temp' by this amount when pre-cooling is active." class="spc-label">Pre-Cool Offset</label>
            <label for="historyLogInterval" title="How often to log sensor history (in minutes)." class="spc-label">History Log Interval</label>

            <div class="number-input-wrapper"><input type="number" id="preCoolTriggerTemp" step="1" value="90.0"></div>
            <div class="number-input-wrapper"><input type="number" id="preCoolTempOffset" step="1" value="5.0"></div>
            <div class="number-input-wrapper"><input type="number" id="historyLogInterval" min="1" max="1440" step="1" required value="5"></div>

            <div class="spc-save-cell" style="grid-column: 1 / span 2; text-align: center; align-self: center; padding-top: 8px;">
              <button class="section-save-btn" onclick="saveSmartPreCooling()">Save Smart Pre-Cooling</button>
            </div>
            <div class="spc-help-cell" style="grid-column: 3; align-self: center;">
              <small class="form-text">Default: 5 min. Range: 1â€“1440 (24h).</small>
            </div>
          </div>
        </div>
    </div>

    <div class="content-section">
      <h2>Feature Toggles <a href="/help#feature-toggles" class="help-link" title="Click for detailed help on these features" aria-label="Help on feature toggles">(?)</a></h2>
      <div class="config-grid">
        <div class="config-item">
          <label for="preCoolingEnabled" title="Enable or disable the forecast-based pre-cooling logic.">Enable Pre-Cooling</label>
          <label class="switch">
            <input type="checkbox" id="preCoolingEnabled">
            <span class="slider"></span>
          </label>
        </div>
        <div class="config-item">
          <label for="onboardLedEnabled" title="Enable or disable the blinking status light on the device.">Enable Status LED</label>
          <label class="switch">
            <input type="checkbox" id="onboardLedEnabled">
            <span class="slider"></span>
          </label>
        </div>
        <div class="config-item">
          <label for="dailyRestartEnabled" title="Automatically restart the device once every 24 hours to improve long-term stability.">Enable Daily Restart</label>
          <label class="switch">
            <input type="checkbox" id="dailyRestartEnabled">
            <span class="slider"></span>
          </label>
        </div>
        <div class="config-item">
          <label for="mqttEnabled" title="Enable or disable MQTT integration for Home Assistant.">Enable MQTT Broker</label>
          <label class="switch">
            <input type="checkbox" id="mqttEnabled">
            <span class="slider"></span>
          </label>
        </div>
        <div class="config-item">
          <label for="mqttDiscoveryEnabled" title="Publish configuration topics for Home Assistant auto-discovery.">Publish HA Discovery</label>
          <label class="switch">
            <input type="checkbox" id="mqttDiscoveryEnabled">
            <span class="slider"></span>
          </label>
        </div>
        <div class="config-item">
          <label for="testModeEnabled" title="Enable the Test Panel with sliders to simulate sensor values.">Enable Test Mode</label>
          <label class="switch">
            <input type="checkbox" id="testModeEnabled">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>

    <div id="timerModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeTimerModal()">&times;</span>
        <h3>Set Manual Timer</h3>
        <div class="config-grid">
          <div class="config-item">
            <label for="timerDelay">Delay Start (mins)</label>
            <div class="number-input-wrapper">
              <input type="number" id="timerDelay" min="0" step="1" value="0">
            </div>
          </div>
          <div class="config-item">
            <label for="timerDuration">Run Duration (mins)</label>
            <div class="number-input-wrapper">
              <input type="number" id="timerDuration" min="1" step="1" value="30">
            </div>
          </div>
        </div>
        <div style="margin-top: 15px;">
          <label for="postTimerAction">After timer ends:</label>
          <select id="postTimerAction" style="padding: 5px; font-size: 1em;"><option value="revert_to_auto">Revert to AUTO</option><option value="stay_manual">Stay MANUAL (Fan Off)</option></select>
        </div>
        <div style="margin-top: 20px;"><button class="btn" onclick="startTimedRun()">Start Timed Run</button></div>
      </div>
    </div>

    <div id="test-panel" class="content-section">
      <h2>ðŸ§ª Test Panel</h2>
      <h4 class="config-subheading" style="text-align: center;">Simulated Temps</h4>
      <div class="config-grid">
        <div class="config-item">
          <label for="simulatedAtticTemp">Attic: <span id="attic-temp-val">--</span>Â°F</label>
          <input type="range" id="simulatedAtticTemp" min="50" max="150" step="1" oninput="updateTempDisplay('attic-temp-val', this.value); setSliderInteraction(true)">
        </div>
        <div class="config-item">
          <label for="simulatedOutdoorTemp">Outdoor: <span id="outdoor-temp-val">--</span>Â°F</label>
          <input type="range" id="simulatedOutdoorTemp" min="30" max="120" step="1" oninput="updateTempDisplay('outdoor-temp-val', this.value); setSliderInteraction(true)">
        </div>
      </div>
      <div style="text-align: center; margin-top: 15px;">
        <button onclick="updateTestTemps()" class="section-save-btn">Update Temps</button>
      </div>
      <hr style="margin: 20px 0;">
      <p>Put device into AP Mode to change WiFi credentials:</p>
      <button onclick="forceAPMode()" class="section-save-btn btn-danger">Force AP Mode</button>
    </div>

    <div class="content-section">
      <h2>System & Maintenance</h2>
      <div class="system-controls">
        <button onclick="window.location.href='/update_wrapper'" class="section-save-btn">Firmware Update</button>
        <a href="/diagnostics" class="section-save-btn" download>Download Diagnostics</a>
        <button onclick="clearDiagnostics()" class="section-save-btn">Clear Diagnostics</button>
        <a href="/history.csv" class="section-save-btn" download>Download History (CSV)</a>
        <button onclick="restartDevice()" class="section-save-btn btn-danger">Restart Device</button>
        <button onclick="resetConfig()" class="section-save-btn btn-danger">Reset to Defaults</button>
      </div>
    </div>  
  <div style="margin-top: 20px; font-size: 0.8em; color: #888;">
    Firmware Version: <span id="firmwareVersion">--</span>
  </div>
</div><div id="saveToast" class="toast" style="visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 1; left: 50%; transform: translateX(-50%); bottom: 30px;"></div>  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js library for the history graph -->
  <script>
    let testMode = false;
    let isInteractingWithSlider = false;
    let historyChart;
    let currentFanState = false;
    const fanIconEl = document.getElementById("fan-icon");
    const fanKeyframes = `
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }`;
    const styleSheet = document.createElement("style");
    styleSheet.innerText = fanKeyframes;
    document.head.appendChild(styleSheet);
    function fetchAndRenderHistory() {
      fetch('/history.csv')
        .then(res => {
          if (!res.ok) throw new Error('No history log found.');
          return res.text();
        })
        .then(csv => {
          const lines = csv.trim().split(/\r?\n/);
          if (lines.length < 2) {
            document.getElementById('historyChartMsg').textContent = 'No historical data logged yet.';
            if (historyChart) historyChart.destroy();
            return;
          }
          const header = lines[0].split(',');
          const timeIdx = header.indexOf('timestamp');
          const atticIdx = header.indexOf('attic_temp'); 
          if (timeIdx < 0 || atticIdx < 0) {
            document.getElementById('historyChartMsg').textContent = 'CSV format error: missing columns.';
            return; 
          }
          const outdoorIdx = header.indexOf('outdoor_temp');
          const humidityIdx = header.indexOf('humidity');
          const fanOnIdx = header.indexOf('fan_on');

          const labels = [];
          const attic = [];
          const outdoor = [];
          const humidity = [];
          const fanOn = [];
          for (let i = 1; i < lines.length; ++i) {
            const row = lines[i].split(',');
            const ts = row[timeIdx];
            if (ts) { 
              labels.push(ts.substring(5, 16).replace('T', ' '));
            } else { 
              labels.push('');
            }
            attic.push(parseFloat(row[atticIdx]));
            if (outdoorIdx >= 0) outdoor.push(parseFloat(row[outdoorIdx]));
            if (humidityIdx >= 0) humidity.push(parseFloat(row[humidityIdx]));
            if (fanOnIdx >= 0) fanOn.push(parseInt(row[fanOnIdx], 10));
          }
          const N = 100;
          const start = labels.length > N ? labels.length - N : 0;
          const chartLabels = labels.slice(start);
          const chartAttic = attic.slice(start);
          const chartOutdoor = outdoorIdx >= 0 ? outdoor.slice(start) : undefined;
          const chartHumidity = humidityIdx >= 0 ? humidity.slice(start) : undefined;
          const chartFanOn = fanOnIdx >= 0 ? fanOn.slice(start) : undefined;

          const datasets = [
            { label: 'Attic Temp (Â°F)', data: chartAttic, borderColor: '#e67e22', backgroundColor: 'rgba(230,126,34,0.1)', yAxisID: 'y', tension: 0.2 },
            { label: 'Outdoor Temp (Â°F)', data: chartOutdoor, borderColor: '#2980b9', backgroundColor: 'rgba(41,128,185,0.1)', yAxisID: 'y', tension: 0.2, hidden: chartOutdoor === undefined }
          ];
          if (chartHumidity) datasets.push({ label: 'Attic Humidity (%)', data: chartHumidity, borderColor: '#27ae60', backgroundColor: 'rgba(39,174,96,0.1)', yAxisID: 'y2', tension: 0.2, hidden: chartHumidity === undefined });
          if (chartFanOn) datasets.push({ label: 'Fan On', data: chartFanOn, borderColor: '#9b59b6', backgroundColor: 'rgba(155,89,182,0.2)', yAxisID: 'y3', tension: 0.2, stepped: true, fill: true, hidden: chartFanOn === undefined });

          const ctx = document.getElementById('historyChart').getContext('2d');
          if (historyChart) historyChart.destroy();
          historyChart = new Chart(ctx, {
            type: 'line',
            data: { labels: chartLabels, datasets: datasets },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: 'index', intersect: false },
              plugins: {
                legend: { position: 'top' },
                title: { display: false },
                tooltip: { enabled: true }
              },
              scales: {
                y: {
                  type: 'linear',
                  display: true,
                  position: 'left',
                  title: { display: true, text: 'Temperature (Â°F)' }
                },
                y2: { type: 'linear', display: chartHumidity !== undefined, position: 'right', title: { display: true, text: 'Humidity (%)' }, grid: { drawOnChartArea: false }, min: 0, max: 100 },
                y3: { type: 'linear', display: false, position: 'right', min: -0.5, max: 1.5 }
              }
            }
          });
          document.getElementById('historyChartMsg').textContent = '';
        })
        .catch(err => {
          document.getElementById('historyChartMsg').textContent = 'No historical data available.';
          if (historyChart) historyChart.destroy();
        }); 
    }

    function saveCoreAutomation() {
      const fanOnTemp = document.getElementById("fanOnTemp").value;
      const fanDeltaTemp = document.getElementById("fanDeltaTemp").value;
      const fanHysteresis = document.getElementById("fanHysteresis").value;
      const configPayload = {
        fanOnTemp: parseFloat(fanOnTemp),
        fanDeltaTemp: parseFloat(fanDeltaTemp),
        fanHysteresis: parseFloat(fanHysteresis)
      };
      fetch("/config", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(configPayload)
      })
      .then(res => Promise.all([res.ok, res.text()]))
      .then(([ok, text]) => {
        if (ok) {
          showToast("Core Automation settings saved!");
        } else {
          showToast("Save failed!");
        }
      })
      .catch(err => {
        console.error("Failed to save core automation:", err);
        showToast("Save failed!");
      });
    }

    function saveSmartPreCooling() {
      const preCoolTriggerTemp = document.getElementById("preCoolTriggerTemp").value;
      const preCoolTempOffset = document.getElementById("preCoolTempOffset").value;
      const logIntervalMin = parseInt(document.getElementById("historyLogInterval").value, 10);
      const configPayload = {
        preCoolTriggerTemp: parseFloat(preCoolTriggerTemp),
        preCoolTempOffset: parseFloat(preCoolTempOffset)
      };
      if (!isNaN(logIntervalMin) && logIntervalMin > 0) {
        configPayload.historyLogIntervalMs = logIntervalMin * 60000;
      }
      fetch("/config", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(configPayload)
      })
      .then(res => Promise.all([res.ok, res.text()]))
      .then(([ok, text]) => {
        if (ok) {
          showToast("Smart Pre-Cooling settings saved!");
        } else {
          showToast("Save failed!");
        }
      })
      .catch(err => {
        console.error("Failed to save smart pre-cooling:", err);
        showToast("Save failed!");
      });
    }

    function updateSensorData() {
      if (testMode) {
        // In local test mode, we don't fetch status. The sliders and manual controls are the source of truth.
        return;
      }
      fetch("/status")
        .then(res => res.json())
        .then(data => {
          document.getElementById("firmwareVersion").textContent = data.firmwareVersion;
          document.getElementById("atticTemp").textContent = data.atticTemp;
          document.getElementById("atticHumidity").textContent = data.atticHumidity;
          document.getElementById("outdoorTemp").textContent = data.outdoorTemp;
          const fanOn = data.fanOn;
          currentFanState = fanOn;
          updateFanVisual(fanOn);
          document.getElementById("currentMode").textContent = data.fanMode;

          const timerStatusEl = document.getElementById('timerStatus');
          if (data.timerActive) {
            const minutes = Math.floor(data.timerRemainingSec / 60);
            const seconds = data.timerRemainingSec % 60;
            const remainingTime = `${minutes}m ${String(seconds).padStart(2, '0')}s`;
            if (data.timerMode === 'delay') {
              timerStatusEl.innerHTML = `Timer starts in: ${remainingTime}`;
            } else {
              timerStatusEl.innerHTML = `Timer runs for: ${remainingTime}`;
            }
            timerStatusEl.style.display = 'block';
          } else {
            timerStatusEl.style.display = 'none';
          }

          // Show test panel if enabled on the device
          if (data.testModeEnabled) {
            document.getElementById('test-panel').style.display = 'block';
            const atticSlider = document.getElementById('simulatedAtticTemp');
            const outdoorSlider = document.getElementById('simulatedOutdoorTemp');
            if (!isInteractingWithSlider) {
              atticSlider.value = data.simulatedAtticTemp;
              outdoorSlider.value = data.simulatedOutdoorTemp;
            }
            updateTempDisplay('attic-temp-val', atticSlider.value);
            updateTempDisplay('outdoor-temp-val', outdoorSlider.value);
          }

          // Sync the UI mode with the device's actual mode
          setMode(data.fanMode, false); // Update UI without sending a command back

          // After setting the mode, refine the manual button states
          if (data.fanMode === 'MANUAL') {
          var manualOnBtn = document.getElementById("manualOnBtn");
          var manualOffBtn = document.getElementById("manualOffBtn");
          if (manualOnBtn) manualOnBtn.disabled = fanOn;
          if (manualOffBtn) manualOffBtn.disabled = !fanOn;
          }
        })
        .catch(() => {
          document.getElementById("firmwareVersion").textContent = "--";
          document.getElementById("atticTemp").textContent = "--";
          document.getElementById("atticHumidity").textContent = "--";
          document.getElementById("outdoorTemp").textContent = "--";
          document.getElementById("currentMode").textContent = "--";
        });
    }

    function updateWeatherData() {
      if (testMode) {
        // In test mode, fetch directly from Open-Meteo.
        // NOTE: This only works if you serve index.html from a local web server (e.g., `python -m http.server`).
        // It will fail if you open the file directly via file:// due to browser security (CORS).
        const lat = 38.72; // From hardware.h - MUST be updated manually
        const lon = -121.36; // From hardware.h - MUST be updated manually
        const url = `http://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relativehumidity_2m,weathercode&daily=weathercode,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&windspeed_unit=mph&precipitation_unit=inch&forecast_days=3&timezone=auto`;

        fetch(url)
          .then(res => res.json())
          .then(data => {
            document.getElementById("currentWeatherIcon").textContent = weatherCodeToEmoji(data.current.weathercode);
            document.getElementById("currentWeatherTemp").textContent = data.current.temperature_2m.toFixed(1);
            document.getElementById("currentWeatherHumidity").textContent = data.current.relativehumidity_2m;

            const forecastContainer = document.getElementById("forecastContainer");
            forecastContainer.innerHTML = ""; // Clear old forecast

            data.daily.time.forEach((time, index) => {
              // In test mode, we must calculate the day of the week from the date string
              const dayOfWeek = new Date(time).getUTCDay();
              const dayDiv = document.createElement("div");
              dayDiv.className = "forecast-day";
              dayDiv.innerHTML = `
                <div>${dayOfWeekToString(dayOfWeek, index === 0)}</div>
                <div class="emoji">${weatherCodeToEmoji(data.daily.weathercode[index])}</div>
                <div><strong>${Math.round(data.daily.temperature_2m_max[index])}Â°</strong> / ${Math.round(data.daily.temperature_2m_min[index])}Â°</div>
              `;
              forecastContainer.appendChild(dayDiv);
            });
          })
          .catch(err => {
            // Instead of showing an error, render mock data for a better local testing experience when file is opened directly.
            console.warn("Direct weather fetch failed (likely due to CORS). Rendering mock weather data for local testing.", err);
            const forecastContainer = document.getElementById("forecastContainer");
            forecastContainer.innerHTML = ""; // Clear old forecast
            document.getElementById("currentWeatherIcon").textContent = "â˜€ï¸";
            document.getElementById("currentWeatherTemp").textContent = "75";
            document.getElementById("currentWeatherHumidity").textContent = "55";

            const mockForecast = [
                { dayOfWeek: new Date().getUTCDay(), icon: 'â˜€ï¸', max: '85', min: '65' },
                { dayOfWeek: (new Date().getUTCDay() + 1) % 7, icon: 'â›…', max: '82', min: '63' },
                { dayOfWeek: (new Date().getUTCDay() + 2) % 7, icon: 'ðŸŒ¦ï¸', max: '78', min: '60' }
            ];

            mockForecast.forEach((day, index) => {
                const dayDiv = document.createElement("div");
                dayDiv.className = "forecast-day";
                dayDiv.innerHTML = `
                  <div>${dayOfWeekToString(day.dayOfWeek, index === 0)}</div>
                  <div class="emoji">${day.icon}</div>
                  <div><strong>${day.max}Â°</strong> / ${day.min}Â°</div>
                `;
                forecastContainer.appendChild(dayDiv);
            });
          });
        return;
      }

      fetch("/weather")
        .then(res => res.json())
        .then(data => {
          document.getElementById("currentWeatherIcon").textContent = data.currentIcon;
          document.getElementById("currentWeatherTemp").textContent = data.currentTemp;
          document.getElementById("currentWeatherHumidity").textContent = data.currentHumidity;

          const forecastContainer = document.getElementById("forecastContainer");
          forecastContainer.innerHTML = ""; // Clear old forecast

          data.forecast.forEach((day, index) => {
            const dayDiv = document.createElement("div");
            dayDiv.className = "forecast-day";
            dayDiv.innerHTML = `
              <div>${dayOfWeekToString(day.dayOfWeek, index === 0)}</div>
              <div class="emoji">${day.icon}</div>
              <div><strong>${day.max}Â°</strong> / ${day.min}Â°</div>
            `;
            forecastContainer.appendChild(dayDiv);
          });
        }).catch(err => console.error("Failed to fetch weather:", err));
    }

    function dayOfWeekToString(dayIndex, isToday) {
      if (isToday) return "Today";
      const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      if (dayIndex >= 0 && dayIndex < 7) {
        return days[dayIndex];
      }
      return "Day " + (dayIndex + 1); // Fallback
    }

    function weatherCodeToEmoji(code) {
      if (code == 0) return "â˜€ï¸"; // Clear sky
      if (code >= 1 && code <= 3) return "â›…"; // Mainly clear, partly cloudy, overcast
      if (code >= 45 && code <= 48) return "ðŸŒ«ï¸"; // Fog
      if (code >= 51 && code <= 57) return "ðŸ’§"; // Drizzle
      if (code >= 61 && code <= 67) return "ðŸŒ§ï¸"; // Rain
      if (code >= 71 && code <= 77) return "â„ï¸"; // Snow
      if (code >= 80 && code <= 82) return "ðŸŒ¦ï¸"; // Rain showers
      if (code >= 85 && code <= 86) return "ðŸŒ¨ï¸"; // Snow showers
      if (code >= 95 && code <= 99) return "â›ˆï¸"; // Thunderstorm
      return "â“";
    }

    function setMode(newMode, sendCommand = true) {
      const isManual = newMode === 'MANUAL';
      document.getElementById('autoModeBtn').disabled = !isManual;
      document.getElementById('manualModeBtn').disabled = isManual;
      if (testMode) {
        document.getElementById("currentMode").textContent = newMode;
      }

      const manualOnBtn = document.getElementById("manualOnBtn");
      const manualOffBtn = document.getElementById("manualOffBtn");
      const setTimerBtn = document.getElementById("setTimerBtn");

      if (isManual) {
        // When switching to manual, enable buttons based on the current fan state
        if (manualOnBtn) manualOnBtn.disabled = currentFanState;
        if (manualOffBtn) manualOffBtn.disabled = !currentFanState;
        if (setTimerBtn) setTimerBtn.disabled = false;
      } else {
        // If not in manual mode, disable all manual buttons
        if (manualOnBtn) manualOnBtn.disabled = true;
        if (manualOffBtn) manualOffBtn.disabled = true;
        if (setTimerBtn) setTimerBtn.disabled = true;
      }

      if (sendCommand) {
        if (newMode === 'AUTO') {
          fetch("/fan?state=auto").then(res => { if(res.ok) updateSensorData(); }).catch(err => console.error("Failed to set auto mode:", err));
        } else if (newMode === 'MANUAL') {
          // Preserve the current fan state when switching to manual.
          const stateToSet = currentFanState ? 'on' : 'off';
          fetch("/fan?state=" + stateToSet).then(res => { if(res.ok) updateSensorData(); }).catch(err => console.error("Failed to set manual mode:", err));
        }
      }
    }

    function setFan(state) {
      if (testMode) {
        const fanIsOn = (state === 'on');
        currentFanState = fanIsOn; // Update the global state
        updateFanVisual(fanIsOn);
        // Update the button disabled states to reflect the new fan state
        document.getElementById('manualOnBtn').disabled = fanIsOn;
        document.getElementById('manualOffBtn').disabled = !fanIsOn;
        return;
      }
      // Send the command and then immediately trigger a status update for a responsive UI.
      fetch("/fan?state=" + state)
        .then(res => {
          if (res.ok) updateSensorData();
        })
        .catch(err => {
          console.error("Fan toggle failed:", err);
        });
    }

    async function loadConfig() {
      if (testMode) {
        return; // In local test mode, defaults are used from the HTML value attributes.
      }
      try {
        const response = await fetch("/config");
        const data = await response.json();
        document.getElementById("fanOnTemp").value = data.fanOnTemp;
        document.getElementById("fanDeltaTemp").value = data.fanDeltaTemp;
        document.getElementById("fanHysteresis").value = data.fanHysteresis;
        document.getElementById("preCoolTriggerTemp").value = data.preCoolTriggerTemp;
        document.getElementById("preCoolTempOffset").value = data.preCoolTempOffset;
        document.getElementById("preCoolingEnabled").checked = data.preCoolingEnabled;
        document.getElementById("onboardLedEnabled").checked = data.onboardLedEnabled;
        document.getElementById("testModeEnabled").checked = data.testModeEnabled;
        document.getElementById("dailyRestartEnabled").checked = data.dailyRestartEnabled;
        document.getElementById("mqttEnabled").checked = data.mqttEnabled;
        document.getElementById("mqttDiscoveryEnabled").checked = data.mqttDiscoveryEnabled;
        if (data.historyLogIntervalMs) {
          const intervalInput = document.getElementById("historyLogInterval");
          if(intervalInput) intervalInput.value = Math.round(data.historyLogIntervalMs / 60000);
        }
      } catch (err) {
        console.error("Failed to load config:", err);
      }
    }

    function saveConfig() {
      if (testMode) return;
      const fanOnTemp = document.getElementById("fanOnTemp").value;
      const fanDeltaTemp = document.getElementById("fanDeltaTemp").value;
      const fanHysteresis = document.getElementById("fanHysteresis").value;
      const preCoolTriggerTemp = document.getElementById("preCoolTriggerTemp").value;
      const preCoolTempOffset = document.getElementById("preCoolTempOffset").value;
      const preCoolingEnabled = document.getElementById("preCoolingEnabled").checked;
      const onboardLedEnabled = document.getElementById("onboardLedEnabled").checked;
      const testModeEnabled = document.getElementById("testModeEnabled").checked;
      const dailyRestartEnabled = document.getElementById("dailyRestartEnabled").checked;
      const mqttEnabled = document.getElementById("mqttEnabled").checked;
      const mqttDiscoveryEnabled = document.getElementById("mqttDiscoveryEnabled").checked;

      const logIntervalMin = parseInt(document.getElementById("historyLogInterval").value, 10);
      const configPayload = {
        fanOnTemp: parseFloat(fanOnTemp),
        fanDeltaTemp: parseFloat(fanDeltaTemp),
        fanHysteresis: parseFloat(fanHysteresis),
        preCoolTriggerTemp: parseFloat(preCoolTriggerTemp),
        preCoolTempOffset: parseFloat(preCoolTempOffset),
        preCoolingEnabled: preCoolingEnabled,
        onboardLedEnabled: onboardLedEnabled,
        dailyRestartEnabled: dailyRestartEnabled,
        testModeEnabled: testModeEnabled,
        mqttEnabled: mqttEnabled,
        mqttDiscoveryEnabled: mqttDiscoveryEnabled
      };
      if (!isNaN(logIntervalMin) && logIntervalMin > 0) {
        configPayload.historyLogIntervalMs = logIntervalMin * 60000;
      }
      fetch("/config", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(configPayload) // Corrected: use the payload object
      })
      .then(res => Promise.all([res.ok, res.text()]))
      .then(([ok, text]) => {
        if (ok) {
          showToast("Configuration saved!");
          // Use the more informative message from the server
          if (text.includes("restart") && confirm(text + " Restart now?")) { restartDevice(); }
        } else {
          showToast("Save failed!");
        }
      })
      .catch(err => {
        console.error("Failed to save config:", err);
        showToast("Save failed!");
      });
    }

    function restartDevice() {
      if (testMode) {
        alert("Restart command sent (test mode).");
        return;
      }
      if (confirm("Are you sure you want to restart the device?")) {
        fetch("/restart")
          .then(() => {
            alert("Device is restarting. The page will become unresponsive.");
          })
          .catch(err => console.error("Failed to send restart command:", err));
      }
    }

    function resetConfig() {
      if (testMode) {
        alert("Config reset to defaults (test mode).");
        return;
      }
      if (confirm("Are you sure you want to reset all settings to their factory defaults? This action cannot be undone.")) {
        fetch("/reset_config")
          .then(() => {
            alert("Configuration has been reset. The device will now restart.");
            setTimeout(() => location.reload(), 5000); // Reload the page to show the new default settings
          })
          .catch(err => console.error("Failed to reset config:", err));
      }
    }

    function setSliderInteraction(isInteracting) {
      // When the user interacts with a slider, set a flag.
      // This prevents the periodic status update from overwriting the slider's position.
      // The flag is reset only when "Update Temps" is clicked successfully.
      isInteractingWithSlider = isInteracting;
    }

    function openTimerModal() {
      document.getElementById('timerModal').style.display = 'block';
    }

    function closeTimerModal() {
      document.getElementById('timerModal').style.display = 'none';
    }

    function startTimedRun() {
      const delay = document.getElementById('timerDelay').value;
      const duration = document.getElementById('timerDuration').value;
      const postAction = document.getElementById('postTimerAction').value;

      fetch('/fan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'start_timed',
          delay: parseInt(delay, 10),
          duration: parseInt(duration, 10),
          postAction: postAction
        })
      })
      .then(res => {
        if (res.ok) {
          showToast("Timed run started!");
          closeTimerModal();
        } else {
          showToast("Failed to start timer.");
        }
      })
      .catch(err => console.error("Failed to start timed run:", err));
    }

    function toggleInfo(element) {
      const targetId = element.getAttribute('data-target');
      const targetElement = document.getElementById(targetId);
      if (targetElement) {
        targetElement.style.display = targetElement.style.display === 'block' ? 'none' : 'block';
      }
    }

    function updateTempDisplay(elementId, value) {
      document.getElementById(elementId).textContent = value;
    }

    function updateTestTemps() {
      const attic = document.getElementById('simulatedAtticTemp').value;
      const outdoor = document.getElementById('simulatedOutdoorTemp').value;
      fetch(`/test/set_temps?attic=${attic}&outdoor=${outdoor}`)
        .then(res => {
          const success = res.ok;
          showToast(success ? "Test temps updated." : "Update failed.");
          if (success) {
            // On success, reset the interaction flag so the UI will sync with the device again.
            setSliderInteraction(false);
          }
        })
        .catch(err => console.error("Failed to set test temps:", err));
    }

    // Add change event listeners to feature toggles for immediate save
    document.addEventListener("DOMContentLoaded", function() {
      ["preCoolingEnabled", "onboardLedEnabled", "dailyRestartEnabled", "mqttEnabled", "mqttDiscoveryEnabled", "testModeEnabled"].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) {
          el.addEventListener("change", saveConfig);
        }
      });
    });

    function forceAPMode() {
      if (testMode) {
        alert("AP Mode command sent (test mode)."); return;
      }
      if (confirm("This will force the device into AP mode and disconnect it from your WiFi. Are you sure?")) {
        fetch('/test/force_ap')
          .then(() => showToast("AP Mode command sent."))
          .catch(err => console.error("Failed to force AP mode:", err));
      }
    }

    function clearDiagnostics() {
      if (testMode) {
        alert("Clear diagnostics command sent (test mode)."); return;
      }
      if (confirm("Are you sure you want to permanently delete the diagnostics log? This action cannot be undone.")) {
        fetch("/clear_diagnostics")
          .then(res => res.text())
          .then(text => {
            showToast(text);
          })
          .catch(err => {
            console.error("Failed to clear diagnostics:", err);
            showToast("Error clearing diagnostics log.");
          });
      }
    }

    function showToast(message) {
      const toast = document.getElementById("saveToast");
      toast.textContent = message;
      toast.style.visibility = "visible";
      setTimeout(() => {
        toast.style.visibility = "hidden";
      }, 3000);
    }

    function updateFanVisual(isFanOn) {
      const fanStateEl = document.getElementById("fanState");
      fanStateEl.textContent = isFanOn ? "ON" : "OFF";
      if (isFanOn) {
        fanIconEl.style.animation = 'spin 1s linear infinite';
      } else {
        fanIconEl.style.animation = 'none';
      }
    }

    async function initializeApp() {
      // Set initial UI state for controls
      setMode('AUTO', false); // Set a default, will be corrected by first status update
      await loadConfig();
      updateSensorData();
      updateWeatherData();
      fetchAndRenderHistory();
      setInterval(fetchAndRenderHistory, 5 * 60 * 1000); // Refresh history every 5 min
      setInterval(updateSensorData, 3000); // Refresh status every 3 seconds for a responsive UI
      setInterval(updateWeatherData, 600000); // Update weather every 10 minutes
    }

    // Close modal if user clicks outside of it
    window.onclick = function(event) {
      const modal = document.getElementById('timerModal');
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }

    window.addEventListener("pageshow", function(event) {
      if (event.persisted) {
        loadConfig();
      }
    });
    // Check if the ESP endpoint is reachable to determine the environment.
    // This allows the same index.html to be used for local testing (file://) and live on the device.
    fetch("/fan?state=ping", { method: 'GET', signal: AbortSignal.timeout(2000) })
      .then(res => {
        if (!res.ok) throw new Error("Not live");
        console.log("ESP detected, running in live mode.");
        // No special setup needed for live mode.
      })
      .catch(() => {
        console.warn("ESP not detected, running in local test mode.");
        testMode = true;
        // Manually show the test panel for local viewing.
        document.getElementById('test-panel').style.display = 'block';
        const atticSlider = document.getElementById('simulatedAtticTemp');
        const outdoorSlider = document.getElementById('simulatedOutdoorTemp');
        atticSlider.value = 95;
        outdoorSlider.value = 88;
        // Populate the main display with initial test values
        document.getElementById("atticTemp").textContent = atticSlider.value;
        document.getElementById("atticHumidity").textContent = "55"; // A reasonable default
        document.getElementById("outdoorTemp").textContent = outdoorSlider.value;
        document.getElementById("currentMode").textContent = "AUTO"; // Default to AUTO mode
        // Populate the test panel slider labels
        updateTempDisplay('attic-temp-val', atticSlider.value);
        updateTempDisplay('outdoor-temp-val', outdoorSlider.value);
      })
      .finally(() => {
        // This runs after the fetch succeeds or fails, ensuring the app always initializes.
        initializeApp();
      });
  </script>
</body>
</html>